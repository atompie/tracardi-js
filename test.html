<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Traverse Body Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .info {
            margin-bottom: 20px;
        }

        .diary-entry {
            margin: 20px 0;
            padding: 10px;
        }
    </style>
</head>
<body>
<div>
    <div id="stats-overlay" style="height: 80px"></div>
    <div class="info">
        We start from <code>document.body</code> and traverse all children.
        <ul>
            <li>Any element with <code>class="diary-entry"</code> has a red border.</li>
            <li>Inside those diary entries, allowed tags (e.g., <code>&lt;p&gt;</code>, <code>&lt;h1&gt;</code>) get a
                blue border.
            </li>
        </ul>
    </div>

    <div class="diary-entry">
        <p>This is the first diary entry paragraph.</p>
        <div>Some text in a DIV.</div>
        <h2>An H2 heading</h2>
    </div>

    <section>
        <div class="diary-entry">
            <h1>Another Diary Entry</h1>
            <p>Paragraph #1</p>
            <ul>
                <li>List item A</li>
                <li>List item B</li>
            </ul>
        </div>
    </section>

    <p>Some text outside of diary entries.</p>
</div>


<script>

    function toggleStatsDisplay(element) {
        if(element.stat) {
            const statsText = Object.entries(element.stat)
                .map(([key, value]) => `${key}: ${value}`)
                .join("<br>");

            const existingOverlay = document.getElementById("stats-overlay");
            existingOverlay.innerHTML = element.tagName + statsText;
        }


    }

    const ALLOWED_ROOT_TAGS = new Set(["UL", "DIV"]);
    // Define which tags we consider allowed for the "blue border" step.
    const ALLOWED_SUB_TAGS = new Set(["P", "H1", "H2", "H3", "H4", "H5", "H6", "LI", "DIV"]);

    /**
     * Check if an element fits in the current viewport (height <= window height).
     */
    function fitsInViewport(el) {
        const rect = el.getBoundingClientRect();
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        return rect.height <= viewportHeight;
    }

    function addRootEvents(child) {

        child.stat = {
            visible: 0
        }

        child.addEventListener('mouseover', (event) => {
            toggleStatsDisplay(event.target);
        });

        child.addEventListener('mouseout', (event) => {
            toggleStatsDisplay(event.target);
        });

        child.addEventListener("click", (event) => {
            toggleStatsDisplay(event.target);
        });

    }

    function addChildEvents(child) {

        child.stat = {
            visible: 0,
            clicks: 0,
            mouseOver: 0
        }

        child.addEventListener('mouseover', (event) => {
            if (!child.mouseOverStartTime) {
                child.mouseOverStartTime = Date.now();
            }
            toggleStatsDisplay(event.target);
        });

        child.addEventListener('mouseout', (event) => {
            if (child.mouseOverStartTime) {
                child.stat.mouseOver += Date.now() - child.mouseOverStartTime;
                child.mouseOverStartTime = null;
            }
            toggleStatsDisplay(event.target);
        });

        child.addEventListener("click", (event) => {
            child.stat.clicks++;
            toggleStatsDisplay(event.target);
        });

    }

    // Recursively applies a blue border to all children with allowed tags.
    function markAllowedChildren(element) {
        for (const child of element.children) {
            if (ALLOWED_SUB_TAGS.has(child.tagName)) {
                child.style.border = "2px solid blue";
                addChildEvents(child)
            }
            // Continue down the tree
            markAllowedChildren(child);
        }
    }

    // Recursively traverse the entire body and:
    // 1) If an element has class "diary-entry", give it a red border.
    // 2) Then, mark its allowed-tag children in blue.
    // 3) Otherwise, keep traversing deeper.
    function traverseDom(root) {
        for (const child of root.children) {
            if (ALLOWED_ROOT_TAGS.has(child.tagName) && fitsInViewport(child)) {
                // Give the diary-entry a red border
                child.style.border = "2px solid red";

                addRootEvents(child)

                // Inside this diary-entry, mark allowed tags blue
                markAllowedChildren(child);
            } else {
                child.style.border = "2px solid transparent";
                // Not a diary-entry, keep looking deeper
                traverseDom(child);
            }
        }
    }

    function handleDomTraversal() {
        const start = performance.now();

        traverseDom(document.body);

        const end = performance.now();
        console.log(`DOM traversal took: ${(end - start).toFixed(2)} ms`);
    }

    window.addEventListener("resize", handleDomTraversal);
    // Once the DOM is loaded, start from document.body
    window.addEventListener("DOMContentLoaded", handleDomTraversal);
</script>
</body>
</html>
